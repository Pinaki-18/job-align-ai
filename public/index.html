<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobAlign AI | Resume Scorer</title>
    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; }
        h1 { text-align: center; color: var(--primary); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        label { display: block; margin-bottom: 10px; font-weight: bold; }
        textarea { width: 100%; height: 150px; background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn:hover { background: #4f46e5; }
        
        /* Results */
        #resultArea { display: none; margin-top: 30px; }
        .score-card { text-align: center; padding: 40px; background: #1e293b; border: 2px solid var(--primary); }
        .score-number { font-size: 4rem; font-weight: bold; color: var(--primary); }
        .summary-box { margin-top: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-left: 4px solid var(--primary); text-align: left;}
        .keywords-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; justify-content: center; }
        .keyword-tag { background: #ef4444; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; }
        .loader { display: none; margin: 20px auto; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>JobAlign AI üöÄ</h1>

    <div class="card" style="margin-bottom: 20px; text-align: center;">
        <label>üìÑ Upload Resume (PDF)</label>
        <input type="file" id="resumeUpload" accept=".pdf" style="color: white;">
    </div>

    <div class="grid">
        <div class="card">
            <label>1. Resume Text</label>
            <textarea id="resumeText" placeholder="Paste resume here..."></textarea>
        </div>
        <div class="card">
            <label>2. Job Description</label>
            <textarea id="jobDescription" placeholder="Paste JD here..."></textarea>
        </div>
    </div>

    <button class="btn" onclick="analyzeResume()">Analyze Match ‚ú®</button>
    
    <div class="loader" id="loadingSpinner"></div>

    <div id="resultArea">
        <div class="card score-card">
            <div style="color: #94a3b8;">Match Score</div>
            <div class="score-number" id="scoreValue">0%</div>
            <div class="summary-box">
                <strong>AI Summary:</strong>
                <p id="summaryText">Loading...</p>
            </div>
            <div style="margin-top: 25px;">
                <label>‚ö†Ô∏è Missing Keywords:</label>
                <div class="keywords-list" id="keywordsArea"></div>
            </div>
        </div>
    </div>
</div>

<script>
    console.log("‚úÖ Script Loaded Successfully!");

    // 1. PDF Upload Function
    document.getElementById('resumeUpload').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('resumeText').value = "Extracting text...";

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const res = await fetch('/extract-text', { method: 'POST', body: formData });
            const data = await res.json();
            document.getElementById('resumeText').value = data.success ? data.text : "Error extracting text.";
        } catch (err) {
            console.error(err);
            alert("Upload failed.");
        }
    });

    // 2. Analyze Function (This is what the button looks for)
    async function analyzeResume() {
        console.log("üñ±Ô∏è Button Clicked! Starting Analysis...");
        
        const resumeText = document.getElementById('resumeText').value;
        const jdText = document.getElementById('jobDescription').value;

        if (!resumeText || !jdText) {
            alert("Please fill in both boxes!");
            return;
        }

        // Show Loading
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('resultArea').style.display = 'none';

        try {
            console.log("üì° Sending request to server...");
            const res = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ resumeText, jobDescription: jdText })
            });

            const data = await res.json();
            console.log("üì© Response received:", data);

            if (data.success) {
                // Update UI
                document.getElementById('scoreValue').innerText = data.analysis.match_score + "%";
                document.getElementById('summaryText').innerText = data.analysis.summary;
                
                const kwArea = document.getElementById('keywordsArea');
                kwArea.innerHTML = ""; 
                if(data.analysis.missing_keywords) {
                    data.analysis.missing_keywords.forEach(kw => {
                        const tag = document.createElement('span');
                        tag.className = 'keyword-tag';
                        tag.innerText = kw;
                        kwArea.appendChild(tag);
                    });
                }
                
                // Show Result
                document.getElementById('resultArea').style.display = 'block';
            } else {
                alert("AI Error: " + data.message);
            }

        } catch (err) {
            console.error("Fetch error:", err);
            alert("Could not connect to server. Is it running?");
        } finally {
            document.getElementById('loadingSpinner').style.display = 'none';
        }
    }
</script>

</body>
</html>